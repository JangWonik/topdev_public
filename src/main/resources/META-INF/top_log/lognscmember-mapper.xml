<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="LogMemberMapper">

	<select id="kmember" parameterType="java.util.HashMap" resultType="kr.co.toplac.lslog.LogMemberVO">
		SELECT a.user_name name , a.user_no user_id, b.team_type, b.team_name
		FROM top_mbr_bsc a, top_tm_bsc b
		WHERE a.team_id_main=#{team_id}
		AND ((a.user_state='1' AND a.out_date >= UNIX_TIMESTAMP(#{fromdate}))
			OR (a.user_state!='1' AND a.join_date &lt; UNIX_TIMESTAMP(#{todate})))
		AND a.team_id_main = b.team_id
		ORDER BY a.work_type, a.work_level DESC, a.user_no ASC
	</select>

	<select id="logmember" parameterType="java.util.HashMap" resultType="kr.co.toplac.lslog.LogMemberVO">
		select ifnull(reg_m,0) reg_m, ifnull(reg_y,0) reg_y, ifnull(end_m,0) end_m, ifnull(end_y,0) end_y
			, ifnull(round((end_m/reg_m)*100,1),0) proc_m, ifnull(round((end_y/reg_y)*100,1),0) proc_y
			, ifnull(nend_p,0) nend_p, ifnull(round((nend_30/nend_p)*100),0) nend_30r
			, ea_sum
			, ea_sum + ea_pl1 - ea_mi report_ea
			, ifnull(price_assess,0) price_assess, ifnull(price_time,0) price_time
			, p_price_pl1_a-p_price_mi_a p_price_a
			, p_price_pl1_b-p_price_mi_b p_price_b
			, ifnull(price_assess,0) + ifnull(price_time,0) + (p_price_pl1_a-p_price_mi_a)
				+ (p_price_pl1_b-p_price_mi_b) sum_little
			, ifnull(price_traffic,0) price_traffic, ifnull(price_question,0) price_question, ifnull(price_receipt,0) price_receipt
			, ifnull(price_assess,0) + ifnull(price_time,0) + (p_price_pl1_a-p_price_mi_a) + (p_price_pl1_b-p_price_mi_b)
				+ ifnull(price_traffic,0) + ifnull(price_question,0) + ifnull(price_receipt,0) sum_hap
			, ifnull(no_settle,0) no_settle
		from	
			(SELECT COUNT(suim_rpt_no) reg_m FROM top_rpt_head where user_no=#{tmpStr}
				and reg_date>=UNIX_TIMESTAMP(#{fromdate}) and reg_date &lt; UNIX_TIMESTAMP(#{todate})
			) a
			,(SELECT COUNT(suim_rpt_no) reg_y FROM top_rpt_head WHERE user_no=#{tmpStr}
				and reg_date>=UNIX_TIMESTAMP(#{fromYear}) and reg_date &lt; UNIX_TIMESTAMP(#{toYear})
			) b
			,(SELECT COUNT(suim_rpt_no) end_m FROM top_rpt_head WHERE user_no=#{tmpStr}
				and close_date>=UNIX_TIMESTAMP(#{fromdate}) and close_date &lt; UNIX_TIMESTAMP(#{todate})
			) c
			,(SELECT COUNT(suim_rpt_no) end_y FROM top_rpt_head WHERE user_no=#{tmpStr}
				and close_date>=UNIX_TIMESTAMP(#{fromYear}) and close_date &lt; UNIX_TIMESTAMP(#{toYear})
			) d
			,(SELECT COUNT(suim_rpt_no) nend_p FROM top_rpt_head WHERE user_no=#{tmpStr}
				and suim_rpt_state!='2' and suim_rpt_state!='3') e
			,(SELECT COUNT(suim_rpt_no) nend_30 FROM top_rpt_head WHERE user_no=#{tmpStr}
				and suim_rpt_state!='2' and suim_rpt_state!='3' and reg_date &lt; unix_timestamp(CURRENT_TIMESTAMP())-(#{minusDay})
			) f
			,(select ifnull(sum(suim_rpt_ea),0) ea_sum FROM top_rpt_head WHERE user_no=#{tmpStr}
				and close_date >= UNIX_TIMESTAMP(#{fromdate}) and close_date &lt; UNIX_TIMESTAMP(#{todate})
			) g1
			,(select ifnull(sum(g2x.collabo_pp * 0.01 * g2y.suim_rpt_ea),0) ea_pl1
				from top_rpt_collabo g2x, top_rpt_head g2y
				where g2x.user_id = #{tmpStr}
				and g2x.suim_rpt_no = g2y.suim_rpt_no
				and g2y.close_date>=UNIX_TIMESTAMP(#{fromdate}) and g2y.close_date &lt; UNIX_TIMESTAMP(#{todate})
				and g2y.suim_rpt_type1 in (1,2,11,12,13,14,15,16,17,18,19)
			) g2
			,(select ifnull(sum(g5y.collabo_pp * 0.01 * g5x.suim_rpt_ea),0) ea_mi
				from top_rpt_head g5x, top_rpt_collabo g5y
				where g5x.user_no = #{tmpStr}
				and g5x.close_date>=UNIX_TIMESTAMP(#{fromdate}) and g5x.close_date &lt; UNIX_TIMESTAMP(#{todate})
				and g5x.suim_rpt_type1 in (1,2,11,12,13,14,15,16,17,18,19)
				and g5x.suim_rpt_no = g5y.suim_rpt_no
			) g5
			,(select ifnull(sum(h2.amt_basic),0) price_assess, ifnull(sum(h2.amt_daily),0) price_time, ifnull(sum(h2.amt_traffic),0) price_traffic
				, ifnull(sum(h2.amt_counsel),0) price_question, ifnull(sum(h2.amt_etc),0) price_receipt
				from top_rpt_head h1, top_rpt_invoice h2
				where h1.user_no = #{tmpStr}
				and h1.close_date >= unix_timestamp(#{fromdate}) and h1.close_date &lt; unix_timestamp(#{todate})
				and h1.suim_rpt_no = h2.suim_rpt_no
			) h
			,(select sum_id2 + sum_price2 p_price_pl1_a
				from
					(select ifnull(sum(j11x.collabo_pp),0) sum_id2
						from top_rpt_collabo j11x, top_rpt_head j11y
						where j11x.user_id = #{tmpStr}
						and j11x.suim_rpt_no = j11y.suim_rpt_no
						and j11y.close_date>=UNIX_TIMESTAMP(#{fromdate}) and j11y.close_date &lt; UNIX_TIMESTAMP(#{todate})
						and j11y.suim_rpt_type1 in (3,4)
					) j11
					,(select ifnull(sum(j12z.amt_basic * j12x.collabo_pp * 0.01),0) sum_price2
						from top_rpt_collabo j12x, top_rpt_head j12y, top_rpt_invoice j12z
						where j12x.user_id = #{tmpStr}
						and j12x.suim_rpt_no = j12y.suim_rpt_no
						and j12y.close_date>=UNIX_TIMESTAMP(#{fromdate}) and j12y.close_date &lt; UNIX_TIMESTAMP(#{todate})
						and j12y.suim_rpt_type1 in (1,2,11,12,13,14,15,16,17,18,19)
						and j12x.suim_rpt_no = j12z.suim_rpt_no
					) j12
			) j1
			,(select sum_mi + sum_price_mi p_price_mi_a
				from
					(select ifnull(sum(j41x.collabo_pp),0) sum_mi
						from top_rpt_collabo j41x, top_rpt_head j41y
						where j41y.user_no = #{tmpStr}
						and j41y.close_date>=UNIX_TIMESTAMP(#{fromdate}) and j41y.close_date &lt; UNIX_TIMESTAMP(#{todate})
						and j41y.suim_rpt_type1 in (3,4)
						and j41y.suim_rpt_no = j41x.suim_rpt_no
					) j41
					,(select ifnull(sum(j42z.amt_basic * j42x.collabo_pp * 0.01),0) sum_price_mi
						from top_rpt_collabo j42x, top_rpt_head j42y, top_rpt_invoice j42z
						where j42y.user_no = #{tmpStr}
						and j42y.close_date>=UNIX_TIMESTAMP(#{fromdate}) and j42y.close_date &lt; UNIX_TIMESTAMP(#{todate})
						and j42y.suim_rpt_type1 in (1,2,11,12,13,14,15,16,17,18,19)
						and j42y.suim_rpt_no = j42x.suim_rpt_no
						and j42x.suim_rpt_no = j42z.suim_rpt_no
					) j42
			) j4
			,(select ifnull(sum(K1z.amt_daily * K1x.collabo_pp * 0.01),0) p_price_pl1_b
				from top_rpt_collabo K1x, top_rpt_head K1y, top_rpt_invoice K1z
				where K1x.user_id = #{tmpStr}
				and K1x.suim_rpt_no = K1y.suim_rpt_no
				and K1y.close_date>=UNIX_TIMESTAMP(#{fromdate}) and K1y.close_date &lt; UNIX_TIMESTAMP(#{todate})
				and K1y.suim_rpt_type1 in (1,2,11,12,13,14,15,16,17,18,19)
				and K1x.suim_rpt_no = K1z.suim_rpt_no
			) k1
			,(select ifnull(sum(K4z.amt_daily * K4x.collabo_pp * 0.01),0) p_price_mi_b
				from top_rpt_collabo K4x, top_rpt_head K4y, top_rpt_invoice K4z
				where K4y.user_no = #{tmpStr}
				and K4y.close_date>=UNIX_TIMESTAMP(#{fromdate}) and K4y.close_date &lt; UNIX_TIMESTAMP(#{todate})
				and K4y.suim_rpt_type1 in (1,2,11,12,13,14,15,16,17,18,19)
				and K4y.suim_rpt_no = K4x.suim_rpt_no
				and K4x.suim_rpt_no = K4z.suim_rpt_no
			) K4
			,(select sum(m2.amt_total) no_settle
				from top_rpt_head m1, top_rpt_invoice m2
				where m1.user_no = #{tmpStr} and m1.close_date &gt; 0
				and m1.suim_rpt_no = m2.suim_rpt_no and m2.deposit_date &lt; 1
			) m
			,(select sum(suim_rpt_ea) endea_m
				FROM top_rpt_head
				where user_no = #{tmpStr}
				and close_date >= unix_timestamp(#{fromdate}) and close_date &lt; unix_timestamp(#{todate})
			) p
	</select>

</mapper>
