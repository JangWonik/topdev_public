<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="MisTmBscPrimMbrMapper">

	<select id="getMisPrimTmMbrList" parameterType="kr.co.toplac.topstatistics.MisTmBscViewVO" resultType="String">
		SELECT mbrBsc.user_no
		FROM top_mbr_bsc mbrBsc
		WHERE mbrBsc.team_id_main = #{team_id}
		AND ((mbrBsc.user_state='1' AND mbrBsc.out_date >= UNIX_TIMESTAMP(#{viewFromDate}))
			OR (mbrBsc.user_state!='1' AND mbrBsc.join_date &lt; UNIX_TIMESTAMP(DATE_ADD(#{viewToDate},INTERVAL 1 day))))
		ORDER BY mbrBsc.work_type, mbrBsc.work_level DESC, mbrBsc.user_no ASC
	</select>

	<select id="getMisPrimTmMbr2List" parameterType="kr.co.toplac.topstatistics.MisTmBscViewVO" resultType="String">
		SELECT DISTINCT user_no from top_rpt_head
		WHERE team_id = #{team_id}
		AND close_date >= unix_timestamp(#{viewFromDate})
		AND close_date &lt; unix_timestamp(DATE_ADD(#{viewToDate},INTERVAL 1 day))
		UNION
		SELECT DISTINCT user_no from top_prim_biz_rpt_head
		WHERE team_id = #{team_id}
		AND close_date >= unix_timestamp(#{viewFromDate})
		AND close_date &lt; unix_timestamp(DATE_ADD(#{viewToDate},INTERVAL 1 day))
	</select>

	<select id="getMisTmBscPrimMbr1" parameterType="kr.co.toplac.topstatistics.MisTmBscViewVO" resultType="kr.co.toplac.topstatistics.MisTmBscVO">
		SELECT tmMbr.user_no, tmMbr.user_name, tmMbr.team_id, tmMbr.team_name
			, ifnull(ea_sum_nsc,0) ea_sum_nsc
			, ifnull(price_assess_nsc,0) price_assess_nsc, ifnull(price_time_nsc,0) price_time_nsc
			, ifnull(p_price_a_nsc,0) p_price_a_nsc, ifnull(p_price_b_nsc,0) p_price_b_nsc
			, ifnull(price_assess_nsc,0) + ifnull(price_time_nsc,0) + ifnull(p_price_a_nsc,0) + ifnull(p_price_b_nsc,0) price_sum_little_nsc
			, ifnull(price_traffic_nsc,0) price_traffic_nsc, ifnull(price_question_nsc,0) price_question_nsc, ifnull(price_receipt_nsc,0) price_receipt_nsc
			, ifnull(price_assess_nsc,0) + ifnull(price_time_nsc,0) + ifnull(p_price_a_nsc,0) + ifnull(p_price_b_nsc,0)
				+ ifnull(price_traffic_nsc,0) + ifnull(price_question_nsc,0) + ifnull(price_receipt_nsc,0) price_sum_hap_nsc
			, ifnull(no_settle_nsc,0) no_settle_nsc
			, ea_sum + ifnull(ea_pl1,0) - ifnull(ea_mi,0) ea_sum
			, ifnull(price_assess,0) price_assess, ifnull(price_time,0) price_time
			, ifnull(p_price_pl1_a,0)-ifnull(p_price_mi_a,0) p_price_a
			, ifnull(p_price_pl1_b,0)-ifnull(p_price_mi_b,0) p_price_b
			, ifnull(price_assess,0) + ifnull(price_time,0) + (ifnull(p_price_pl1_a,0)-ifnull(p_price_mi_a,0))
				+ (ifnull(p_price_pl1_b,0)-ifnull(p_price_mi_b,0)) price_sum_little
			, ifnull(price_traffic,0) price_traffic, ifnull(price_question,0) price_question, ifnull(price_receipt,0) price_receipt
			, ifnull(price_assess,0) + ifnull(price_time,0) + (ifnull(p_price_pl1_a,0)-ifnull(p_price_mi_a,0))
				+ (ifnull(p_price_pl1_b,0)-ifnull(p_price_mi_b,0))
				+ ifnull(price_traffic,0) + ifnull(price_question,0) + ifnull(price_receipt,0) price_sum_hap
			, ifnull(no_settle,0) no_settle
		FROM
			(SELECT mbrBsc.team_id_main team_id, mbrBsc.user_no, mbrBsc.user_name, tmBsc.team_name
			FROM top_mbr_bsc mbrBsc, top_tm_bsc tmBsc
			WHERE mbrBsc.user_no = #{user_no}
			AND mbrBsc.team_id_main = tmBsc.team_id) tmMbr
			, (select ifnull(sum(a1.share_amt_basic),0) price_assess_nsc, ifnull(sum(a1.share_amt_daily),0) price_time_nsc
						from top_prim_biz_inv_share a1, top_prim_biz_rpt_head a2
						where a1.share_user_no=#{user_no}
						and a1.suim_rpt_no = a2.suim_rpt_no
						and a2.user_no=#{user_no}
						and a2.close_date >= unix_timestamp(#{viewFromDate})
						and a2.close_date &lt; unix_timestamp(DATE_ADD(#{viewToDate},INTERVAL 1 day))
				) a
			, (select ifnull(sum(b1.share_amt_basic),0) p_price_a_nsc, ifnull(sum(b1.share_amt_daily),0) p_price_b_nsc
						from top_prim_biz_inv_share b1, top_prim_biz_rpt_head b2
						where b1.share_user_no=#{user_no}
						and b1.suim_rpt_no = b2.suim_rpt_no
						and b2.user_no!=#{user_no}
						and b2.close_date >= unix_timestamp(#{viewFromDate})
						and b2.close_date &lt; unix_timestamp(DATE_ADD(#{viewToDate},INTERVAL 1 day))
				) b
			, (select ifnull(sum(c1.share_ea),0) ea_sum_nsc, ifnull(sum(c1.share_amt_traffic),0) price_traffic_nsc
						, ifnull(sum(c1.share_amt_counsel),0) price_question_nsc, ifnull(sum(c1.share_amt_etc),0) price_receipt_nsc
						from top_prim_biz_inv_share c1, top_prim_biz_rpt_head c2
						where c1.share_user_no=#{user_no}
						and c1.suim_rpt_no = c2.suim_rpt_no
						and c2.close_date >= unix_timestamp(#{viewFromDate})
						and c2.close_date &lt; unix_timestamp(DATE_ADD(#{viewToDate},INTERVAL 1 day))
				) c
			, (select ifnull(sum(d1.share_amt_total),0) no_settle_nsc
						from top_prim_biz_inv_share d1, top_prim_biz_rpt_head d2, top_prim_biz_inv d3
						where d1.share_user_no=#{user_no}
						and d1.suim_rpt_no = d2.suim_rpt_no
						and (d2.close_date IS NOT NULL AND d2.close_date &gt; 0)
						and d2.suim_rpt_no = d3.suim_rpt_no
						and (d3.deposit_date IS NULL OR d3.deposit_date &lt; 1)
				) d
			, (SELECT ifnull(sum(suim_rpt_ea),0) ea_sum FROM top_rpt_head
						WHERE user_no=#{user_no}
						and close_date >= UNIX_TIMESTAMP(#{viewFromDate})
						and close_date &lt; UNIX_TIMESTAMP(DATE_ADD(#{viewToDate},INTERVAL 1 day))
				) g1
			, (select ifnull(sum(g2x.collabo_pp * 0.01 * g2y.suim_rpt_ea),0) ea_pl1
						from top_rpt_collabo g2x, top_rpt_head g2y
						where g2x.user_id=#{user_no}
						and g2x.suim_rpt_no = g2y.suim_rpt_no
						and g2y.close_date>=UNIX_TIMESTAMP(#{viewFromDate})
						and g2y.close_date &lt; UNIX_TIMESTAMP(DATE_ADD(#{viewToDate},INTERVAL 1 day))
				) g2
			, (select ifnull(sum(g5y.collabo_pp * 0.01 * g5x.suim_rpt_ea),0) ea_mi
						from top_rpt_head g5x, top_rpt_collabo g5y
						where g5x.user_no=#{user_no}
						and g5x.close_date>=UNIX_TIMESTAMP(#{viewFromDate})
						and g5x.close_date &lt; UNIX_TIMESTAMP(DATE_ADD(#{viewToDate},INTERVAL 1 day))
						and g5x.suim_rpt_no = g5y.suim_rpt_no
				) g5
			, (select ifnull(sum(h2.amt_basic),0) price_assess, ifnull(sum(h2.amt_daily),0) price_time, ifnull(sum(h2.amt_traffic),0) price_traffic
						, ifnull(sum(h2.amt_counsel),0) price_question, ifnull(sum(h2.amt_etc),0) price_receipt
						from top_rpt_head h1, top_rpt_invoice h2
						where h1.user_no=#{user_no}
						and h1.close_date >= unix_timestamp(#{viewFromDate})
						and h1.close_date &lt; unix_timestamp(DATE_ADD(#{viewToDate},INTERVAL 1 day))
						and h1.suim_rpt_no = h2.suim_rpt_no
				) h
			, (select ifnull(sum(j12z.amt_basic * j12x.collabo_pp * 0.01),0) p_price_pl1_a
								from top_rpt_collabo j12x, top_rpt_head j12y, top_rpt_invoice j12z
								where j12x.user_id=#{user_no}
								and j12y.close_date>=UNIX_TIMESTAMP(#{viewFromDate})
								and j12y.close_date &lt; UNIX_TIMESTAMP(DATE_ADD(#{viewToDate},INTERVAL 1 day))
								and j12x.suim_rpt_no = j12y.suim_rpt_no
								and j12x.suim_rpt_no = j12z.suim_rpt_no
				) j1
			, (select ifnull(sum(j42z.amt_basic * j42x.collabo_pp * 0.01),0) p_price_mi_a
								from top_rpt_collabo j42x, top_rpt_head j42y, top_rpt_invoice j42z
								where j42y.user_no=#{user_no}
								and j42y.close_date>=UNIX_TIMESTAMP(#{viewFromDate})
								and j42y.close_date &lt; UNIX_TIMESTAMP(DATE_ADD(#{viewToDate},INTERVAL 1 day))
								and j42y.suim_rpt_no = j42x.suim_rpt_no
								and j42x.suim_rpt_no = j42z.suim_rpt_no
				) j4
			, (select ifnull(sum(K1z.amt_daily * K1x.collabo_pp * 0.01),0) p_price_pl1_b
						from top_rpt_collabo K1x, top_rpt_head K1y, top_rpt_invoice K1z
						where K1x.user_id=#{user_no}
						and K1y.close_date>=UNIX_TIMESTAMP(#{viewFromDate})
						and K1y.close_date &lt; UNIX_TIMESTAMP(DATE_ADD(#{viewToDate},INTERVAL 1 day))
						and K1x.suim_rpt_no = K1y.suim_rpt_no
						and K1x.suim_rpt_no = K1z.suim_rpt_no
				) k1
			, (select ifnull(sum(K4z.amt_daily * K4x.collabo_pp * 0.01),0) p_price_mi_b
						from top_rpt_collabo K4x, top_rpt_head K4y, top_rpt_invoice K4z
						where K4y.user_no=#{user_no}
						and K4y.close_date>=UNIX_TIMESTAMP(#{viewFromDate})
						and K4y.close_date &lt; UNIX_TIMESTAMP(DATE_ADD(#{viewToDate},INTERVAL 1 day))
						and K4y.suim_rpt_no = K4x.suim_rpt_no
						and K4x.suim_rpt_no = K4z.suim_rpt_no
				) K4
			, (select sum(m2.amt_total) no_settle
						from top_rpt_head m1, top_rpt_invoice m2
						where m1.user_no=#{user_no}
						and (m1.close_date IS NOT NULL AND m1.close_date &gt; 0)
						and m1.suim_rpt_no = m2.suim_rpt_no
						and (m2.deposit_date IS NULL OR m2.deposit_date &lt; 1)
				) m
	</select>

	<select id="getMisTmBscPrimMbr4" parameterType="kr.co.toplac.topstatistics.MisTmBscViewVO" resultType="kr.co.toplac.topstatistics.MisTmBscVO">
		SELECT tmMbr.user_no, tmMbr.user_name, tmMbr.team_id, tmMbr.team_name
			, ifnull(ea_sum_nsc,0) ea_sum_nsc
			, ifnull(price_assess_nsc,0) price_assess_nsc, ifnull(price_time_nsc,0) price_time_nsc
			, ifnull(p_price_a_nsc,0) p_price_a_nsc, ifnull(p_price_b_nsc,0) p_price_b_nsc
			, ifnull(price_assess_nsc,0) + ifnull(price_time_nsc,0) + ifnull(p_price_a_nsc,0) + ifnull(p_price_b_nsc,0) price_sum_little_nsc
			, ifnull(price_traffic_nsc,0) price_traffic_nsc, ifnull(price_question_nsc,0) price_question_nsc, ifnull(price_receipt_nsc,0) price_receipt_nsc
			, ifnull(price_assess_nsc,0) + ifnull(price_time_nsc,0) + ifnull(p_price_a_nsc,0) + ifnull(p_price_b_nsc,0)
				+ ifnull(price_traffic_nsc,0) + ifnull(price_question_nsc,0) + ifnull(price_receipt_nsc,0) price_sum_hap_nsc
			, ifnull(no_settle_nsc,0) no_settle_nsc
			, ea_sum
			, ifnull(price_assess,0) price_assess, ifnull(price_time,0) price_time
			, ifnull(p_price_pl1_a,0)-ifnull(p_price_mi_a,0) p_price_a
			, 0 p_price_b
			, ifnull(price_assess,0) + ifnull(price_time,0) + (ifnull(p_price_pl1_a,0)-ifnull(p_price_mi_a,0)) price_sum_little
			, ifnull(price_traffic,0) price_traffic, ifnull(price_question,0) price_question, ifnull(price_receipt,0) price_receipt
			, ifnull(price_assess,0) + ifnull(price_time,0) + (ifnull(p_price_pl1_a,0)-ifnull(p_price_mi_a,0))
				+ ifnull(price_traffic,0) + ifnull(price_question,0) + ifnull(price_receipt,0) price_sum_hap
			, ifnull(no_settle,0) no_settle
		FROM
			(SELECT mbrBsc.team_id_main team_id, mbrBsc.user_no, mbrBsc.user_name, tmBsc.team_name
			FROM top_mbr_bsc mbrBsc, top_tm_bsc tmBsc
			WHERE mbrBsc.user_no = #{user_no}
			AND mbrBsc.team_id_main = tmBsc.team_id) tmMbr
			, (select ifnull(sum(a1.share_amt_basic),0) price_assess_nsc, ifnull(sum(a1.share_amt_daily),0) price_time_nsc
						from top_prim_biz_inv_share a1, top_prim_biz_rpt_head a2
						where a1.share_user_no=#{user_no}
						and a1.suim_rpt_no = a2.suim_rpt_no
						and a2.user_no=#{user_no}
						and a2.close_date >= unix_timestamp(#{viewFromDate})
						and a2.close_date &lt; unix_timestamp(DATE_ADD(#{viewToDate},INTERVAL 1 day))
				) a
			, (select ifnull(sum(b1.share_amt_basic),0) p_price_a_nsc, ifnull(sum(b1.share_amt_daily),0) p_price_b_nsc
						from top_prim_biz_inv_share b1, top_prim_biz_rpt_head b2
						where b1.share_user_no=#{user_no}
						and b1.suim_rpt_no = b2.suim_rpt_no
						and b2.user_no!=#{user_no}
						and b2.close_date >= unix_timestamp(#{viewFromDate})
						and b2.close_date &lt; unix_timestamp(DATE_ADD(#{viewToDate},INTERVAL 1 day))
				) b
			, (select ifnull(sum(c1.share_ea),0) ea_sum_nsc, ifnull(sum(c1.share_amt_traffic),0) price_traffic_nsc
						, ifnull(sum(c1.share_amt_counsel),0) price_question_nsc, ifnull(sum(c1.share_amt_etc),0) price_receipt_nsc
						from top_prim_biz_inv_share c1, top_prim_biz_rpt_head c2
						where c1.share_user_no=#{user_no}
						and c1.suim_rpt_no = c2.suim_rpt_no
						and c2.close_date >= unix_timestamp(#{viewFromDate})
						and c2.close_date &lt; unix_timestamp(DATE_ADD(#{viewToDate},INTERVAL 1 day))
				) c
			, (select ifnull(sum(d1.share_amt_total),0) no_settle_nsc
						from top_prim_biz_inv_share d1, top_prim_biz_rpt_head d2, top_prim_biz_inv d3
						where d1.share_user_no=#{user_no}
						and d1.suim_rpt_no = d2.suim_rpt_no
						and (d2.close_date IS NOT NULL AND d2.close_date &gt; 0)
						and d2.suim_rpt_no = d3.suim_rpt_no
						and (d3.deposit_date IS NULL OR d3.deposit_date &lt; 1)
				) d
			, (SELECT ifnull(sum(suim_rpt_ea),0) ea_sum FROM top_rpt_head
						WHERE user_no=#{user_no}
						and close_date >= UNIX_TIMESTAMP(#{viewFromDate})
						and close_date &lt; UNIX_TIMESTAMP(DATE_ADD(#{viewToDate},INTERVAL 1 day))
				) g1
			, (select ifnull(sum(h2.amt_basic),0) price_assess, ifnull(sum(h2.amt_daily),0) price_time, ifnull(sum(h2.amt_traffic),0) price_traffic
						, ifnull(sum(h2.amt_counsel),0) price_question, ifnull(sum(h2.amt_etc),0) price_receipt
						from top_rpt_head h1, top_rpt_invoice h2
						where h1.user_no=#{user_no}
						and h1.close_date >= unix_timestamp(#{viewFromDate})
						and h1.close_date &lt; unix_timestamp(DATE_ADD(#{viewToDate},INTERVAL 1 day))
						and h1.suim_rpt_no = h2.suim_rpt_no
				) h
			, (select ifnull(sum(collabo_pp),0) p_price_pl1_a
								from top_rpt_collabo j12x, top_rpt_head j12y, top_rpt_invoice j12z
								where j12x.user_id=#{user_no}
								and j12y.close_date>=UNIX_TIMESTAMP(#{viewFromDate})
								and j12y.close_date &lt; UNIX_TIMESTAMP(DATE_ADD(#{viewToDate},INTERVAL 1 day))
								and j12x.suim_rpt_no = j12y.suim_rpt_no
								and j12x.suim_rpt_no = j12z.suim_rpt_no
				) j1
			, (select ifnull(sum(j42x.collabo_pp),0) p_price_mi_a
								from top_rpt_collabo j42x, top_rpt_head j42y, top_rpt_invoice j42z
								where j42y.user_no=#{user_no}
								and j42y.close_date>=UNIX_TIMESTAMP(#{viewFromDate})
								and j42y.close_date &lt; UNIX_TIMESTAMP(DATE_ADD(#{viewToDate},INTERVAL 1 day))
								and j42y.suim_rpt_no = j42x.suim_rpt_no
								and j42x.suim_rpt_no = j42z.suim_rpt_no
				) j4
			, (select sum(m2.amt_total) no_settle
						from top_rpt_head m1, top_rpt_invoice m2
						where m1.user_no=#{user_no}
						and (m1.close_date IS NOT NULL AND m1.close_date &gt; 0)
						and m1.suim_rpt_no = m2.suim_rpt_no
						and (m2.deposit_date IS NULL OR m2.deposit_date &lt; 1)
				) m
	</select>

	<select id="getMisTmBscPrimMbr_2" parameterType="kr.co.toplac.topstatistics.MisTmBscViewVO" resultType="kr.co.toplac.topstatistics.MisTmBscVO">
		SELECT tmMbr.user_no, tmMbr.user_name, tmMbr.team_id, tmMbr.team_name
			, ifnull(price_assess_nsc,0) price_assess_nsc, ifnull(price_time_nsc,0) price_time_nsc
			, ifnull(price_assess_nsc,0) + ifnull(price_time_nsc,0) price_sum_little_nsc
			, ifnull(price_traffic_nsc,0) price_traffic_nsc, ifnull(price_question_nsc,0) price_question_nsc, ifnull(price_receipt_nsc,0) price_receipt_nsc
			, ifnull(price_assess_nsc,0) + ifnull(price_time_nsc,0)
				+ ifnull(price_traffic_nsc,0) + ifnull(price_question_nsc,0) + ifnull(price_receipt_nsc,0) price_sum_hap_nsc
			, ifnull(price_assess,0) price_assess, ifnull(price_time,0) price_time
			, ifnull(price_assess,0) + ifnull(price_time,0) price_sum_little
			, ifnull(price_traffic,0) price_traffic, ifnull(price_question,0) price_question, ifnull(price_receipt,0) price_receipt
			, ifnull(price_assess,0) + ifnull(price_time,0)
				+ ifnull(price_traffic,0) + ifnull(price_question,0) + ifnull(price_receipt,0) price_sum_hap
		FROM
			(SELECT mbrBsc.team_id_main team_id, mbrBsc.user_no, mbrBsc.user_name, tmBsc.team_name
			FROM top_mbr_bsc mbrBsc, top_tm_bsc tmBsc
			WHERE mbrBsc.user_no = #{user_no}
			AND mbrBsc.team_id_main = tmBsc.team_id) tmMbr
			, (select ifnull(sum(h2.amt_basic),0) price_assess_nsc, ifnull(sum(h2.amt_daily),0) price_time_nsc, ifnull(sum(h2.amt_traffic),0) price_traffic_nsc
						, ifnull(sum(h2.amt_counsel),0) price_question_nsc, ifnull(sum(h2.amt_etc),0) price_receipt_nsc
						from top_prim_biz_rpt_head h1, top_prim_biz_inv h2
						where h1.team_id=#{team_id} AND h1.user_no=#{user_no}
						and h1.close_date >= unix_timestamp(#{viewFromDate})
						and h1.close_date &lt; unix_timestamp(DATE_ADD(#{viewToDate},INTERVAL 1 day))
						and h1.suim_rpt_no = h2.suim_rpt_no
				) a
			, (select ifnull(sum(h2.amt_basic),0) price_assess, ifnull(sum(h2.amt_daily),0) price_time, ifnull(sum(h2.amt_traffic),0) price_traffic
						, ifnull(sum(h2.amt_counsel),0) price_question, ifnull(sum(h2.amt_etc),0) price_receipt
						from top_rpt_head h1, top_rpt_invoice h2
						where h1.team_id=#{team_id} AND h1.user_no=#{user_no}
						and h1.close_date >= unix_timestamp(#{viewFromDate})
						and h1.close_date &lt; unix_timestamp(DATE_ADD(#{viewToDate},INTERVAL 1 day))
						and h1.suim_rpt_no = h2.suim_rpt_no
				) b
	</select>

</mapper>
