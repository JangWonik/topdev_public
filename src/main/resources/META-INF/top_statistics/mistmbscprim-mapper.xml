<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="MisTmBscPrimMapper">

	<select id="getMisTmBscPrim1" parameterType="kr.co.toplac.topstatistics.MisTmBscViewVO" resultType="kr.co.toplac.topstatistics.MisTmBscVO">
		SELECT tmBsc.team_id, tmBsc.team_name, tmBsc.team_type
			, tmUserCnt
			, ifnull(price_assess,0) price_assess, ifnull(price_time,0) price_time, ifnull(price_assess+price_time,0) price_sum_little
			, ifnull(price_traffic,0) price_traffic, ifnull(price_question,0) price_question, ifnull(price_receipt,0) price_receipt
			, ifnull(price_assess+price_time+price_traffic+price_question+price_receipt,0) price_sum_hap
			, ifnull(no_settle,0) no_settle
			, ifnull(price_assess_nsc,0) price_assess_nsc, ifnull(price_time_nsc,0) price_time_nsc, ifnull(price_assess_nsc+price_time_nsc,0) price_sum_little_nsc
			, ifnull(price_traffic_nsc,0) price_traffic_nsc, ifnull(price_question_nsc,0) price_question_nsc, ifnull(price_receipt_nsc,0) price_receipt_nsc
			, ifnull(price_assess_nsc+price_time_nsc+price_traffic_nsc+price_question_nsc+price_receipt_nsc,0) price_sum_hap_nsc
			, ifnull(no_settle_nsc,0) no_settle_nsc
		FROM
			(SELECT team_order, team_group_order, team_id, team_name, team_type FROM top_tm_bsc
			WHERE team_type=1 AND team_statistics1=0) tmBsc
			LEFT JOIN (select team_id, count(user_no) tmUserCnt
						from (select DISTINCT team_id, user_no from top_rpt_head
								where close_date >= unix_timestamp(#{viewFromDate})
								and close_date &lt; unix_timestamp(DATE_ADD(#{viewToDate},INTERVAL 1 day))
								union
								select DISTINCT team_id, user_no from top_prim_biz_rpt_head
								where close_date >= unix_timestamp(#{viewFromDate})
								and close_date &lt; unix_timestamp(DATE_ADD(#{viewToDate},INTERVAL 1 day))
								)a1
						group by team_id) a ON tmBsc.team_id = a.team_id
			LEFT JOIN (select g1.team_id, sum(g2.amt_basic) price_assess, sum(g2.amt_daily) price_time, sum(g2.amt_traffic) price_traffic
						, sum(g2.amt_counsel) price_question, sum(g2.amt_etc) price_receipt
						from top_rpt_head g1, top_rpt_invoice g2
						where g1.suim_rpt_type1 in (1,2,11,12,13,14,15,16,17,18,19)
						and g1.close_date >= unix_timestamp(#{viewFromDate})
						and g1.close_date &lt; unix_timestamp(DATE_ADD(#{viewToDate},INTERVAL 1 day))
						and g1.suim_rpt_no = g2.suim_rpt_no
						group by g1.team_id) g ON tmBsc.team_id = g.team_id
			LEFT JOIN (select g1.team_id, sum(g2.amt_total) no_settle
						from top_rpt_head g1, top_rpt_invoice g2
						where g1.suim_rpt_type1 in (1,2,11,12,13,14,15,16,17,18,19)
						and (g1.close_date IS NOT NULL AND g1.close_date &gt; 0)
						and g1.suim_rpt_no = g2.suim_rpt_no
						and (g2.deposit_date IS NULL OR g2.deposit_date  &lt; 1)
						group by g1.team_id) h ON tmBsc.team_id = h.team_id
			LEFT JOIN (select g1.team_id, sum(g2.amt_basic) price_assess_nsc, sum(g2.amt_daily) price_time_nsc, sum(g2.amt_traffic) price_traffic_nsc
						, sum(g2.amt_counsel) price_question_nsc, sum(g2.amt_etc) price_receipt_nsc
						from top_prim_biz_rpt_head g1, top_prim_biz_inv g2
						where g1.close_date >= unix_timestamp(#{viewFromDate})
						and g1.close_date &lt; unix_timestamp(DATE_ADD(#{viewToDate},INTERVAL 1 day))
						and g1.suim_rpt_no = g2.suim_rpt_no
						group by g1.team_id) k ON tmBsc.team_id = k.team_id
			LEFT JOIN (select g1.team_id, sum(g2.amt_total) no_settle_nsc
						from top_prim_biz_rpt_head g1, top_prim_biz_inv g2
						where (g1.close_date IS NOT NULL AND g1.close_date &gt; 0)
						and g1.suim_rpt_no = g2.suim_rpt_no
						and (g2.deposit_date IS NULL OR g2.deposit_date  &lt; 1)
						group by g1.team_id) m ON tmBsc.team_id = m.team_id
		ORDER BY tmBsc.team_group_order DESC, tmBsc.team_order DESC
	</select>

	<select id="getMisTmBscPrim4" parameterType="kr.co.toplac.topstatistics.MisTmBscViewVO" resultType="kr.co.toplac.topstatistics.MisTmBscVO">
		SELECT tmBsc.team_id, tmBsc.team_name, tmBsc.team_type
			, tmUserCnt
			, ifnull(price_assess,0) price_assess, ifnull(price_time,0) price_time, ifnull(price_assess+price_time,0) price_sum_little
			, ifnull(price_traffic,0) price_traffic, ifnull(price_question,0) price_question, ifnull(price_receipt,0) price_receipt
			, ifnull(price_assess+price_time+price_traffic+price_question+price_receipt,0) price_sum_hap
			, ifnull(no_settle,0) no_settle
			, ifnull(price_assess_nsc,0) price_assess_nsc, ifnull(price_time_nsc,0) price_time_nsc, ifnull(price_assess_nsc+price_time_nsc,0) price_sum_little_nsc
			, ifnull(price_traffic_nsc,0) price_traffic_nsc, ifnull(price_question_nsc,0) price_question_nsc, ifnull(price_receipt_nsc,0) price_receipt_nsc
			, ifnull(price_assess_nsc+price_time_nsc+price_traffic_nsc+price_question_nsc+price_receipt_nsc,0) price_sum_hap_nsc
			, ifnull(no_settle_nsc,0) no_settle_nsc
		FROM
			(SELECT team_order, team_group_order, team_id, team_name, team_type FROM top_tm_bsc
			WHERE team_type=4 AND team_statistics4=0 ) tmBsc
			LEFT JOIN (select team_id, count(user_no) tmUserCnt
						from (select DISTINCT team_id, user_no from top_rpt_head
								where close_date >= unix_timestamp(#{viewFromDate})
								and close_date &lt; unix_timestamp(DATE_ADD(#{viewToDate},INTERVAL 1 day))
								union
								select DISTINCT team_id, user_no from top_prim_biz_rpt_head
								where close_date >= unix_timestamp(#{viewFromDate})
								and close_date &lt; unix_timestamp(DATE_ADD(#{viewToDate},INTERVAL 1 day))
								)a1
						group by team_id) a ON tmBsc.team_id = a.team_id
			LEFT JOIN (select g1.team_id, sum(g2.amt_basic) price_assess, sum(g2.amt_daily) price_time, sum(g2.amt_traffic) price_traffic
						, sum(g2.amt_counsel) price_question, sum(g2.amt_etc) price_receipt
						from top_rpt_head g1, top_rpt_invoice g2
						where g1.suim_rpt_type1 in (3,4)
						and g1.close_date >= unix_timestamp(#{viewFromDate})
						and g1.close_date &lt; unix_timestamp(DATE_ADD(#{viewToDate},INTERVAL 1 day))
						and g1.suim_rpt_no = g2.suim_rpt_no
						group by g1.team_id) g ON tmBsc.team_id = g.team_id
			LEFT JOIN (select g1.team_id, sum(g2.amt_total) no_settle
						from top_rpt_head g1, top_rpt_invoice g2
						where g1.suim_rpt_type1 in (3,4)
						and (g1.close_date IS NOT NULL AND g1.close_date &gt; 0)
						and g1.suim_rpt_no = g2.suim_rpt_no
						and (g2.deposit_date IS NULL OR g2.deposit_date  &lt; 1)
						group by g1.team_id) h ON tmBsc.team_id = h.team_id
			LEFT JOIN (select g1.team_id, sum(g2.amt_basic) price_assess_nsc, sum(g2.amt_daily) price_time_nsc, sum(g2.amt_traffic) price_traffic_nsc
						, sum(g2.amt_counsel) price_question_nsc, sum(g2.amt_etc) price_receipt_nsc
						from top_prim_biz_rpt_head g1, top_prim_biz_inv g2
						where g1.close_date >= unix_timestamp(#{viewFromDate})
						and g1.close_date &lt; unix_timestamp(DATE_ADD(#{viewToDate},INTERVAL 1 day))
						and g1.suim_rpt_no = g2.suim_rpt_no
						group by g1.team_id) k ON tmBsc.team_id = k.team_id
			LEFT JOIN (select g1.team_id, sum(g2.amt_total) no_settle_nsc
						from top_prim_biz_rpt_head g1, top_prim_biz_inv g2
						where (g1.close_date IS NOT NULL AND g1.close_date &gt; 0)
						and g1.suim_rpt_no = g2.suim_rpt_no
						and (g2.deposit_date IS NULL OR g2.deposit_date  &lt; 1)
						group by g1.team_id) m ON tmBsc.team_id = m.team_id
		ORDER BY tmBsc.team_group_order DESC, tmBsc.team_order DESC
	</select>

</mapper>
