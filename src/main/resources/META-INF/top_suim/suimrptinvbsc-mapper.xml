<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="rptInvoiceBscMapper">

	<select id="getRptInvList" resultType="kr.co.toplac.topsuim.SuimRptInvVO" parameterType="String">
	
		select

		e.team_id,
		e.team_addr,
		e.team_interphone,
		e.team_telephone,
		e.team_fax,
		a.suim_close_no,
		a.suim_accept_no,
		a.suim_rpt_no,
		a.suim_rpt_type1,
		f.ptnr_id,
		getTopPtnrBscPtnrName(f.ptnr_id) ptnr_name,
		c.tax_date,
		DATE_FORMAT(FROM_UNIXTIME(c.tax_date), '%Y-%m-%d') tax_date_fmt,
		a.close_date,
		DATE_FORMAT(FROM_UNIXTIME(a.close_date), '%Y-%m-%d') close_date_fmt,
		c.invoice_date,
		DATE_FORMAT(FROM_UNIXTIME(c.invoice_date), '%Y-%m-%d') invoice_date_fmt,
		a.policyholder_nm,
		a.beneficiary_nm,
		b.policy_no,
		b.accident_no,
		b.insurance_nm,
		DATE_FORMAT(FROM_UNIXTIME(a.accident_date), '%Y-%m-%d') accident_date_fmt,
		a.accident_date,
		c.amt_basic_dtl,
		c.amt_basic,
		c.amt_daily_dtl,
		c.amt_daily,
		c.amt_traffic_dtl,
		c.amt_traffic,
		c.amt_counsel_dtl,
		c.amt_counsel,
		c.amt_etc_dtl,
		c.amt_etc,
		c.amt_total,
		d.top_accnt_nm,
		d.top_accnt_bank,
		d.top_accnt_no,
		d.top_accnt_id,
		a.user_no,
		getTopMbrBscUserName(a.user_no) user_name
		
		from
		top_rpt_head a, top_rpt_body b, top_rpt_invoice c, top_accnt_bsc d, top_tm_bsc e, top_ptnr_bsc f
		
		where
		a.suim_rpt_no = b.suim_rpt_no
		and a.suim_rpt_no = c.suim_rpt_no
		and a.ptnr_id = f.ptnr_id
		and f.top_accnt_id = d.top_accnt_id
		and a.team_id = e.team_id
		
		and a.suim_rpt_no=#{suimRptNo}
		
	</select>
	
	<!-- 인보험 16: 메리츠용 사고 리스트 -->
	<select id="getSagoList16" resultType="kr.co.toplac.topsuim.SuimRptSagoBsc16VO" parameterType="String">
	
		SELECT 
			suim_rpt_no suimRptNo
			, serial_no serialNo
			, control_memo controlMemo
			, control_memo controlMemoSpan
			, control_who controlWho
			, control_relation controlRelation
			, control_contact controlContact
			, DATE_FORMAT(FROM_UNIXTIME(control_date), '%Y-%m-%d') controlDate
			
		FROM
			top_rpt_ctrl_16
		WHERE
			suim_rpt_no = #{suim_rpt_no}
		
	</select>


	<insert id="rptSagoIns" parameterType="kr.co.toplac.topsuim.SuimRptSagoBscVO">
		
		INSERT INTO top_rpt_ctrl
		
		(
			suim_rpt_no, control_subject, control_memo, control_date, reg_date
		)
		
		VALUES
		
		(
			#{suimRptNo}, #{item}, #{content}, unix_timestamp(#{regDate}), unix_timestamp(now())
		)
		
	</insert>
	
	<!-- 인보험 사고처리 과정표 입력 -->
	<insert id="rptSagoIns16" parameterType="kr.co.toplac.topsuim.SuimRptSagoBsc16VO">
		
		INSERT INTO top_rpt_ctrl_16
		
		(
			suim_rpt_no, control_date, control_memo, control_who, control_relation, control_contact , reg_date
		)
		
		VALUES
		
		(
			#{suimRptNo}, unix_timestamp(#{controlDate}), #{controlMemo}, #{controlWho}, #{controlRelation}, #{controlContact}, unix_timestamp(now())
		)
		
	</insert>
	
	<select id="getLatestSagoNo" parameterType="String" resultType="String">
	
		SELECT 
			max(serial_no)
		FROM
			top_rpt_ctrl
		WHERE
			suim_rpt_no = #{suimRptNo}
			
	</select>
	
	<!-- 방금 입력된 사고처리 과정표 16 -->
	<select id="getLatestSago16No" parameterType="String" resultType="String">
	
		SELECT 
			max(serial_no)
		FROM
			top_rpt_ctrl_16
		WHERE
			suim_rpt_no = #{suimRptNo}
			
	</select>
	
	<select id="getSagoOne" parameterType="String" resultType="kr.co.toplac.topsuim.SuimRptSagoBscVO">
	
		SELECT 
			suim_rpt_no suimRptNo
			, serial_no sagoNo
			, control_subject item
			, control_memo content
			, DATE_FORMAT(FROM_UNIXTIME(control_date), '%Y-%m-%d') regDate
		FROM
			top_rpt_ctrl
		WHERE
			serial_no = #{sagoNo}
			
	</select>
	
	<update id="rptSagoUdt" parameterType="kr.co.toplac.topsuim.SuimRptSagoBscVO">
	
		UPDATE
			top_rpt_ctrl
		SET
			control_subject = #{item},
			control_memo = #{content},
			control_date = unix_timestamp(#{regDate})
		WHERE
			serial_no = #{sagoNo}
	
	</update>
	
	<!-- 사고처리 과정표 인보험 : 16 -->
	<update id="rptSagoUdt16" parameterType="kr.co.toplac.topsuim.SuimRptSagoBsc16VO">
	
		UPDATE
			top_rpt_ctrl_16
		SET
			control_date = unix_timestamp(#{controlDate}),
			control_memo = #{controlMemo},
			control_who = #{controlWho},
			control_relation = #{controlRelation},
			control_contact = #{controlContact}
		WHERE
			serial_no = #{serialNo}
	
	</update>
	
	<delete id="rptSagoDel" parameterType="String">
	
		DELETE FROM
			top_rpt_ctrl
		WHERE
			serial_no = #{sagoNo}
	
	</delete>
	
	<!-- 사고처리 과정표 인보험 16 삭제 -->
	<delete id="rptSagoDel16" parameterType="String">
	
		DELETE FROM
			top_rpt_ctrl_16
		WHERE
			serial_no = #{serialNo}
	
	</delete>
	
	<select id="getRptOneForSago" resultType="kr.co.toplac.topsuim.SuimRptCompositeVO" parameterType="String">
	
		SELECT
			  a.insurance_nm
			, b.suim_accept_no
			, b.team_id
			, b.user_no
			, b.ptnr_mbr_no
			, getTopPtnrMbrBscPtnrMbrName(b.ptnr_mbr_no) ptnr_mbr_nm
			, DATE_FORMAT(FROM_UNIXTIME(b.reg_date), '%Y-%m-%d') reg_date 
			, DATE_FORMAT(FROM_UNIXTIME(b.accident_date), '%Y-%m-%d') accident_date
			, getTopMbrBscUserName(b.user_no) user_name
			, b.beneficiary_nm
		FROM
			top_rpt_body a, top_rpt_head b
		WHERE 
			b.suim_rpt_no = #{suimRptNo} and a.suim_rpt_no = b.suim_rpt_no
		ORDER BY
			
			
	
	</select>
	
	<select id="getSagoListForPrint" resultType="kr.co.toplac.topsuim.SuimRptSagoBscVO" parameterType="String">
	
		SELECT 
			suim_rpt_no suimRptNo
			, serial_no sagoNo
			, control_subject item
			, control_memo content
			, DATE_FORMAT(FROM_UNIXTIME(control_date), '%Y-%m-%d') regDate
			
		FROM
			top_rpt_ctrl
		WHERE
			suim_rpt_no = #{suimRptNo}
		ORDER BY
			reg_date ASC
	</select>
	
	<select id="getRptTeamForSago" resultType="kr.co.toplac.topteam.TopTmBscVO" parameterType="String">
	
		SELECT
			 a.team_name
			,a.team_addr
			,a.team_fax
			,a.team_telephone
			
		FROM
			top_tm_bsc a
		WHERE 
			a.team_id = #{team_id}
	
	</select>
	
	<select id="getMbrInfoForSago" resultType="kr.co.toplac.topteam.TopMbrBscVO" parameterType="String">
	
		SELECT
			 a.email
		FROM
			top_mbr_bsc a
		WHERE 
			a.user_no = #{user_no}
	
	</select>

</mapper>
