<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="BoardNoticePtnr4Mapper">

	<select id="ptnrBoardlist" resultType="kr.co.toplac.topptnr.TopPtnrBscVO">
		SELECT a.ptnr_id, a.ptnr_type, a.ptnr_level, a.ptnr_group_order, a.ptnr_order, a.ptnr_nick, a.ptnr_name
		, (SELECT count(ptnr_group_order) FROM top_ptnr_bsc WHERE ptnr_group_order = a.ptnr_group_order AND del_state != 1) ptnr_group_order_cnt
		, (SELECT count(board_no) FROM brd_notice_ptnr4 WHERE ptnr_id = a.ptnr_id) ptnr_notice_cnt
		FROM top_ptnr_bsc a
		WHERE a.del_state != 1
		ORDER BY a.ptnr_group_order DESC, a.ptnr_level, a.ptnr_order DESC
	</select>

	<select id="boardList" parameterType="kr.co.toplac.brd.common.BoardSearchVO" resultType = "kr.co.toplac.brd.common.BoardVO">
		SELECT a.board_no, a.user_no, b.user_name user_nm
			, ptnr_id, getTopPtnrBscPtnrName(ptnr_id) ptnr_name
			, a.title, a.contents, a.reg_ip
			, a.reg_date, DATE_FORMAT(FROM_UNIXTIME(a.reg_date), '%Y-%m-%d %H:%i:%s') reg_date_fmt, a.view_cnt
			, (select count(board_file_no) from brd_notice_ptnr4_file where board_no = a.board_no) file_cnt
		FROM brd_notice_ptnr4 a, top_mbr_bsc b
		WHERE a.ptnr_id = #{insu}
		AND a.user_no = b.user_no
		<choose>
			<when test="boardSrcType == 1">
				<if test="boardSrcWord != ''">
					AND a.title like '%${boardSrcWord}%'
				</if>
			</when>
			<when test="boardSrcType == 2">
				<if test="boardSrcWord != ''">
					AND (a.title like '%${boardSrcWord}%' OR a.contents like '%${boardSrcWord}%')
				</if>
			</when>
			<when test="boardSrcType == 3">
				<if test="boardSrcWord != ''">
					AND b.user_name like '%${boardSrcWord}%'
				</if>
			</when>
		</choose>
		ORDER BY a.board_no DESC
		LIMIT #{queryPgNoInt}, 18
	</select>

	<select id="boardListCnt" parameterType="kr.co.toplac.brd.common.BoardSearchVO" resultType = "int">
		SELECT count(a.board_no) cnt
		FROM brd_notice_ptnr4 a, top_mbr_bsc b
		WHERE a.user_no = b.user_no
		<choose>
			<when test="boardSrcType == 1">
				<if test="boardSrcWord != ''">
					AND a.title like '%${boardSrcWord}%'
				</if>
			</when>
			<when test="boardSrcType == 2">
				<if test="boardSrcWord != ''">
					AND (a.title like '%${boardSrcWord}%' OR a.contents like '%${boardSrcWord}%')
				</if>
			</when>
			<when test="boardSrcType == 3">
				<if test="boardSrcWord != ''">
					AND b.user_name like '%${boardSrcWord}%'
				</if>
			</when>
		</choose>
	</select>

	<insert id="boardWrite" parameterType="kr.co.toplac.brd.common.BoardVO" >
		INSERT INTO brd_notice_ptnr4 (user_no, ptnr_id, title, contents, reg_ip, reg_date, view_cnt)
		VALUES(#{user_no}, #{ptnr_id}, #{title}, #{contents}, #{reg_ip}, unix_timestamp(now()), 0)
	</insert>

	<select id="getBoardNo" parameterType="kr.co.toplac.brd.common.BoardVO" resultType = "String">
		SELECT max(board_no)
		FROM brd_notice_ptnr4
		WHERE user_no = #{user_no}
	</select>

	<insert id="boardFileWrite" parameterType="kr.co.toplac.brd.common.BoardFileVO" >
		INSERT INTO brd_notice_ptnr4_file (board_no,file_path,file_name,reg_date)
		VALUES(#{board_no}, #{file_path}, #{file_name}, unix_timestamp(now()))
	</insert>

	<select id="boardDetail" parameterType="String" resultType = "kr.co.toplac.brd.common.BoardVO">
		SELECT board_no, user_no, getTopMbrBscUserName(user_no) user_nm
			, ptnr_id, getTopPtnrBscPtnrName(ptnr_id) ptnr_name
			, title, contents, reg_ip
			, reg_date, DATE_FORMAT(FROM_UNIXTIME(reg_date), '%Y-%m-%d %H:%i:%s') reg_date_fmt, view_cnt
		FROM brd_notice_ptnr4
		WHERE board_no = #{board_no}
		ORDER BY board_no DESC
	</select>

	<select id="suim4PtnrNoticePop" parameterType="String" resultType = "kr.co.toplac.brd.common.BoardVO">
		SELECT getTopPtnrBscPtnrName(ptnr_id) ptnr_name, contents
		FROM brd_notice_ptnr4
		WHERE ptnr_id = #{id}
		ORDER BY board_no DESC
		Limit 0, 1
	</select>

	<select id="boardFileList" parameterType="String" resultType = "kr.co.toplac.brd.common.BoardFileVO">
		SELECT board_file_no,board_no,file_path,file_name
			, reg_date, DATE_FORMAT(FROM_UNIXTIME(reg_date), '%Y-%m-%d %H:%i:%s') reg_date_fmt
			, CONCAT(file_path, file_name) encodedFilePathName
		FROM brd_notice_ptnr4_file
		WHERE board_no = #{board_no}
		ORDER BY board_file_no
	</select>

	<update id="boardAddCnt" parameterType="String" >
		UPDATE brd_notice_ptnr4 SET view_cnt = view_cnt + 1
		WHERE board_no = #{board_no}
	</update>

	<delete id="boardDelete" parameterType="String" >
		DELETE FROM brd_notice_ptnr4
		WHERE board_no = #{board_no}
	</delete>

	<delete id="boardFilesDelete" parameterType="String" >
		DELETE FROM brd_notice_ptnr4_file
		WHERE board_no = #{board_no}
	</delete>

	<delete id="boardFileDelete" parameterType="String" >
		DELETE FROM brd_notice_ptnr4_file
		WHERE board_file_no = #{fileNo}
	</delete>

	<update id="boardUpdate" parameterType="kr.co.toplac.brd.common.BoardVO" >
		UPDATE brd_notice_ptnr4 SET title = #{title}, contents = #{contents}
		WHERE board_no = #{board_no}
	</update>

	<update id="updateCKPath" parameterType="java.util.HashMap" >
		UPDATE brd_notice_ptnr4 SET contents = REPLACE(contents,#{oldStr},#{newStr})
		WHERE board_no = #{boardNo}
	</update>

	<insert id="boardWrite2" parameterType="kr.co.toplac.brd.common.BoardVO" >
		INSERT INTO brd_notice_ptnr4 (user_no, ptnr_id, title, contents, reg_ip, reg_date, view_cnt)
		VALUES(#{user_no}, #{ptnr_id}, #{title}, #{contents}, #{reg_ip}, #{reg_date}, #{view_cnt})
	</insert>

	<update id="updateCKPath2" parameterType="java.util.HashMap" >
		UPDATE brd_notice_ptnr4 SET contents = REPLACE(contents,#{ckFileDir},#{ckFileDir2})
		WHERE board_no = #{newBoardNo}
	</update>

	<update id="updateBoardFiles" parameterType="java.util.HashMap" >
		UPDATE brd_notice_ptnr4_file
		SET board_no = #{newBoardNo}, file_path = REPLACE(file_path,#{attachFileDir},#{attachFileDir2})
		WHERE board_no = #{boardNo}
	</update>

	<update id="updateBoardMemos" parameterType="java.util.HashMap" >
		UPDATE brd_notice_ptnr4_memo SET fk_no = #{newBoardNo}
		WHERE fk_no = #{boardNo}
	</update>

	<select id="getInsuNm" parameterType="String" resultType = "String">
		select getTopPtnrBscPtnrName(#{insu})
	</select>

	<select id="noticePtnr4FileOneSelect" parameterType="String" resultType="kr.co.toplac.brd.common.BoardFileVO" >
		SELECT board_file_no,board_no,file_path,file_name
			, reg_date, DATE_FORMAT(FROM_UNIXTIME(reg_date), '%Y-%m-%d %H:%i:%s') reg_date_fmt
			, CONCAT(file_path, file_name) encodedFilePathName
		FROM brd_notice_ptnr4_file
		WHERE board_file_no = #{fileNo}
	</select>

</mapper>
