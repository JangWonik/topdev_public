<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="PrimbizLockListMapper">

	<select id="rptPrimLockList" resultType="kr.co.toplac.sysadm.report.RptPrimLockMngCompositeVO">
		SELECT @RN:=@RN+1 AS ROWNUM, TB.* 
		FROM (
			SELECT a.suim_rpt_no, a.suim_accept_no, a.suim_close_no ,a.lock_flag , a.suim_rpt_state , b.rpt_invoice_no
			, a.suim_rpt_type1, getCodeValue('top_prim_biz_rpt_head','suim_rpt_type1',a.suim_rpt_type1) suim_rpt_type1_nm
			, a.team_id, getTopTmBscTeamName(a.team_id) team_name
			, a.user_no, getTopMbrBscUserName(a.user_no) user_name
			, a.ptnr_id, getTopPtnrBscPtnrNick(a.ptnr_id) ptnr_nick, getTopPtnrBscPtnrName(a.ptnr_id) ptnr_name
			, a.ptnr_dept_id, getTopPtnrDeptBscPtnrDeptName(a.ptnr_dept_id) ptnr_dept_nm
			, a.ptnr_mbr_no, getTopPtnrMbrBscPtnrMbrName(a.ptnr_mbr_no) ptnr_mbr_nm
			, a.policyholder_nm, a.beneficiary_nm, a.damaged_nm
			, a.accident_date, if(a.accident_date = null || a.accident_date &lt; 1,'',DATE_FORMAT(FROM_UNIXTIME(a.accident_date), '%Y-%m-%d')) accident_date_fmt
			, a.reg_date, if(a.reg_date = null || a.reg_date &lt; 1,'',DATE_FORMAT(FROM_UNIXTIME(a.reg_date), '%Y-%m-%d')) reg_date_fmt
			, a.close_date, if(a.close_date = null || a.close_date &lt; 1,'',DATE_FORMAT(FROM_UNIXTIME(a.close_date), '%Y-%m-%d')) close_date_fmt
			, a.suim_cancel_date, if(a.suim_cancel_date = null || a.suim_cancel_date &lt; 1,'',DATE_FORMAT(FROM_UNIXTIME(a.suim_cancel_date), '%Y-%m-%d')) suim_cancel_date_fmt
			, DATEDIFF(now(), DATE_FORMAT(FROM_UNIXTIME(a.reg_date), '%Y-%m-%d')) past_date
			FROM top_prim_biz_rpt_head a, top_prim_biz_inv b
			where ((a.close_date > 0 and DATEDIFF(now(), DATE_FORMAT(FROM_UNIXTIME(a.close_date), '%Y-%m-%d')) > 15)
			or (a.suim_cancel_date > 0 and DATEDIFF(now(), DATE_FORMAT(FROM_UNIXTIME(a.suim_cancel_date), '%Y-%m-%d')) > 15))
			and a.suim_rpt_no = b.suim_rpt_no
			ORDER BY a.suim_rpt_no
			) AS TB,
		(SELECT @RN:=0) AS R
		ORDER BY rownum DESC
		
	</select>
	
	<select id="rptPrimLockListExcel" resultType="kr.co.toplac.sysadm.report.RptPrimLockMngCompositeVO">
		SELECT @RN:=@RN+1 AS ROWNUM, TB.* 
		FROM (
			SELECT a.suim_rpt_no, a.suim_accept_no, a.suim_close_no ,a.lock_flag , a.suim_rpt_state , b.rpt_invoice_no
			, a.suim_rpt_type1, getCodeValue('top_prim_biz_rpt_head','suim_rpt_type1',a.suim_rpt_type1) suim_rpt_type1_nm
			, a.team_id, getTopTmBscTeamName(a.team_id) team_name
			, a.user_no, getTopMbrBscUserName(a.user_no) user_name
			, a.ptnr_id, getTopPtnrBscPtnrNick(a.ptnr_id) ptnr_nick, getTopPtnrBscPtnrName(a.ptnr_id) ptnr_name
			, a.ptnr_dept_id, getTopPtnrDeptBscPtnrDeptName(a.ptnr_dept_id) ptnr_dept_nm
			, a.ptnr_mbr_no, getTopPtnrMbrBscPtnrMbrName(a.ptnr_mbr_no) ptnr_mbr_nm
			, a.policyholder_nm, a.beneficiary_nm, a.damaged_nm
			, a.accident_date, if(a.accident_date = null || a.accident_date &lt; 1,'',DATE_FORMAT(FROM_UNIXTIME(a.accident_date), '%Y-%m-%d')) accident_date_fmt
			, a.reg_date, if(a.reg_date = null || a.reg_date &lt; 1,'',DATE_FORMAT(FROM_UNIXTIME(a.reg_date), '%Y-%m-%d')) reg_date_fmt
			, a.close_date, if(a.close_date = null || a.close_date &lt; 1,'',DATE_FORMAT(FROM_UNIXTIME(a.close_date), '%Y-%m-%d')) close_date_fmt
			, a.suim_cancel_date, if(a.suim_cancel_date = null || a.suim_cancel_date &lt; 1,'',DATE_FORMAT(FROM_UNIXTIME(a.suim_cancel_date), '%Y-%m-%d')) suim_cancel_date_fmt
			, DATEDIFF(now(), DATE_FORMAT(FROM_UNIXTIME(a.reg_date), '%Y-%m-%d')) past_date
			FROM top_prim_biz_rpt_head a, top_prim_biz_inv b
			where ((a.close_date > 0 and DATEDIFF(now(), DATE_FORMAT(FROM_UNIXTIME(a.close_date), '%Y-%m-%d')) > 15)
			or (a.suim_cancel_date > 0 and DATEDIFF(now(), DATE_FORMAT(FROM_UNIXTIME(a.suim_cancel_date), '%Y-%m-%d')) > 15))
			and a.suim_rpt_no = b.suim_rpt_no
			ORDER BY a.suim_rpt_no
			) AS TB,
		(SELECT @RN:=0) AS R
		ORDER BY rownum DESC
		
	</select>

	<select id="getPrimbizSuimListCnt" resultType = "int">
		SELECT count(a.suim_rpt_no) cnt
		FROM top_prim_biz_rpt_head a
	</select>
	
	<update id="updateRptPrimLock">
	
		update 
			top_prim_biz_rpt_head
		set
			lock_flag = '1'
		where (
			(close_date > 0 and DATEDIFF(now(), DATE_FORMAT(FROM_UNIXTIME(close_date), '%Y-%m-%d')) > 15)
			or
			(suim_cancel_date > 0 and DATEDIFF(now(), DATE_FORMAT(FROM_UNIXTIME(suim_cancel_date), '%Y-%m-%d')) > 15)
			)
	</update>

</mapper>
