<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="PrimBizRptDtlUdtMapper">

	<update id="updatePrimBizRptBody" parameterType="kr.co.toplac.topprimbiz.TopPrimBizRptCompositeVO">
		UPDATE	top_prim_biz_rpt_body
		SET		moral_flag = #{moral_flag},
				minwon_flag = #{minwon_flag},
				accident_no = #{accident_no},
				policy_no = #{policy_no},
				insurance_nm = #{insurance_nm},
				policyholder_tel = #{policyholder_tel},
				beneficiary_tel = #{beneficiary_tel },
				damaged_tel = #{damaged_tel},
				accident_facts = #{accident_facts},
				investigate_postcode = #{investigate_postcode},
				investigate_addr1 = #{investigate_addr1},
				investigate_addr2 = #{investigate_addr2},
				amt_estimated_damage = #{amt_estimated_damage},
				commission_estimated = #{commission_estimated}
		WHERE	suim_rpt_no = #{suim_rpt_no}
	</update>

	<update id="updatePrimBizRptHead" parameterType="kr.co.toplac.topprimbiz.TopPrimBizRptCompositeVO">
		UPDATE	top_prim_biz_rpt_head
		SET		suim_rpt_type1 = #{suim_rpt_type1},
				policyholder_nm = #{policyholder_nm},
				beneficiary_nm = #{beneficiary_nm},
				damaged_nm = #{damaged_nm},
				accident_date = unix_timestamp(#{accident_date}),
				reg_date = unix_timestamp(#{reg_date})
		WHERE	suim_rpt_no = #{suim_rpt_no}
	</update>

	<insert id="primBizRptLogAdd" parameterType="kr.co.toplac.topprimbiz.TopPrimBizRptCompositeVO">
		INSERT INTO top_prim_biz_rpt_head_log
				(suim_rpt_no, suim_rpt_type1, suim_rpt_state, suim_rpt_type1_close12,
				reg_date, suim_cancel_date, suim_rpt_aprv_date, close_date, del_date,
				lock_flag, moral_flag, minwon_flag,
				log_date, log_ip, log_user_no)
		SELECT	a.suim_rpt_no, a.suim_rpt_type1, a.suim_rpt_state, a.suim_rpt_type1_close12,
				unix_timestamp(now()), a.suim_cancel_date, a.suim_rpt_aprv_date, a.close_date, a.del_date,
				a.lock_flag, b.moral_flag, b.minwon_flag,
				unix_timestamp(now()), #{log_ip}, #{log_user_no}
		FROM	top_prim_biz_rpt_head a, top_prim_biz_rpt_body b
		WHERE	a.suim_rpt_no = b.suim_rpt_no
		AND		a.suim_rpt_no = #{suim_rpt_no}
	</insert>

	<update id="updatePrimBizRptEndBody" parameterType="kr.co.toplac.topprimbiz.TopPrimBizRptCompositeVO">
		UPDATE	top_prim_biz_rpt_body
		SET		amt_estimated_damage = #{amt_estimated_damage}
				,amt_reduction = #{amt_reduction}
				,amt_claimed = #{amt_claimed}
				,amt_settlement = #{amt_settlement}
				,amt_self_pay = #{amt_self_pay}
				,amt_insu_payment = #{amt_insu_payment}
		WHERE	suim_rpt_no = #{suim_rpt_no}
	</update>

	<update id="updatePrimBizRptEndHead" parameterType="kr.co.toplac.topprimbiz.TopPrimBizRptCompositeVO">
		UPDATE	top_prim_biz_rpt_head
		SET		suim_rpt_type1_close12 = #{suim_rpt_type1_close12}
				,suim_rpt_ea = #{suim_rpt_ea}
				,workload_type = #{workload_type}
				,workload_ea = #{workload_ea}
		WHERE	suim_rpt_no = #{suim_rpt_no}
	</update>

	<update id="updatePrimBizRptEndInv" parameterType="kr.co.toplac.topprimbiz.TopPrimBizRptCompositeVO">
		UPDATE	top_prim_biz_inv
		SET		amt_basic_dtl = #{amt_basic_dtl}
				,amt_basic = #{amt_basic}
				,amt_daily_dtl = #{amt_daily_dtl}
				,amt_daily = #{amt_daily}
				,amt_traffic_dtl = #{amt_traffic_dtl}
				,amt_traffic = #{amt_traffic}
				,amt_counsel_dtl = #{amt_counsel_dtl}
				,amt_counsel = #{amt_counsel}
				,amt_etc_dtl = #{amt_etc_dtl}
				,amt_etc = #{amt_etc}
				,amt_total = #{amt_basic} + #{amt_daily} + #{amt_traffic} + #{amt_counsel} + #{amt_etc}
				<if test="invoice_date != ''">
					,invoice_date = unix_timestamp(#{invoice_date})
				</if>
		WHERE	rpt_invoice_no = #{rpt_invoice_no}
	</update>

	<insert id="primBizInvLogAdd" parameterType="kr.co.toplac.topprimbiz.TopPrimBizRptCompositeVO">
		INSERT INTO top_prim_biz_inv_log
				(rpt_invoice_no, suim_rpt_no
				, amt_basic, amt_basic_dtl, amt_daily, amt_daily_dtl, amt_etc, amt_etc_dtl
				, amt_traffic, amt_traffic_dtl, amt_counsel, amt_counsel_dtl, amt_total
				, rpt_invoice_memo, tax_invoice_no
				, invoice_date, deposit_date, tax_date, reg_date, reg_user_no
				, edit_amt_cnt, edit_date_cnt)
		SELECT	rpt_invoice_no, suim_rpt_no
				, amt_basic, amt_basic_dtl, amt_daily, amt_daily_dtl, amt_etc, amt_etc_dtl
				, amt_traffic, amt_traffic_dtl, amt_counsel, amt_counsel_dtl, amt_total
				, rpt_invoice_memo, tax_invoice_no
				, invoice_date, deposit_date, tax_date, unix_timestamp(now()), #{log_user_no}
				, edit_amt_cnt, edit_date_cnt
		FROM	top_prim_biz_inv
		WHERE	rpt_invoice_no = #{rpt_invoice_no}
	</insert>

	<insert id="insertPrimBizShare" parameterType="kr.co.toplac.topprimbiz.TopPrimBizRptCompositeVO"
		useGeneratedKeys="true" keyProperty="serial_no">
		INSERT INTO top_prim_biz_inv_share
		(rpt_invoice_no, suim_rpt_no, share_user_no, share_team_id, share_amt_basic, share_amt_daily, share_amt_traffic, share_amt_counsel, share_amt_etc, share_ea, share_workload_ea, share_amt_total)
		values(
		#{rpt_invoice_no},
		#{suim_rpt_no},
		#{share_user_no}, 
		#{share_team_id},
		#{share_amt_basic},
		#{share_amt_daily}, 
		#{share_amt_traffic}, 
		#{share_amt_counsel}, 
		#{share_amt_etc}, 
		#{share_ea},
		#{share_workload_ea},
		(#{share_amt_basic} + #{share_amt_daily} + #{share_amt_traffic} + #{share_amt_counsel} + #{share_amt_etc})
		);
		<selectKey keyProperty="serial_no" resultType="java.lang.String" order="AFTER">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>

	<insert id="insPrimBizInvShareLogByMap" parameterType="java.util.HashMap">
		INSERT INTO top_prim_biz_inv_share_log
			(prim_biz_inv_share_no, rpt_invoice_no, suim_rpt_no, share_user_no
			, share_amt_basic, share_amt_daily, share_amt_etc, share_amt_traffic, share_amt_counsel
			, share_amt_total, share_ea, share_workload_ea
			, reg_date, reg_user_no, reg_type)
		SELECT serial_no, rpt_invoice_no, suim_rpt_no, share_user_no
			, share_amt_basic, share_amt_daily, share_amt_etc, share_amt_traffic, share_amt_counsel
			, share_amt_total, share_ea, share_workload_ea
			, UNIX_TIMESTAMP(NOW()), #{reg_user_no}, #{reg_type}
		FROM top_prim_biz_inv_share
		WHERE serial_no = #{serial_no}
	</insert>

	<update id="updatePrimBizShare" parameterType="kr.co.toplac.topprimbiz.TopPrimBizRptCompositeVO">
		UPDATE top_prim_biz_inv_share
		SET
		<if test="share_user_no != null">
		share_user_no = #{share_user_no},
		share_team_id = #{share_team_id},
		</if>
		share_amt_basic = #{share_amt_basic},
		share_amt_daily = #{share_amt_daily},
		share_amt_traffic = #{share_amt_traffic},
		share_amt_counsel = #{share_amt_counsel},
		share_amt_etc = #{share_amt_etc},
		share_ea = #{share_ea},
		share_workload_ea = #{share_workload_ea},
		
		share_amt_total = (#{share_amt_basic} + #{share_amt_daily} + #{share_amt_traffic} + #{share_amt_counsel} + #{share_amt_etc})
		WHERE serial_no = #{serial_no}
	</update>

	<update id="deletePrimBizShare" parameterType="kr.co.toplac.topprimbiz.TopPrimBizRptCompositeVO">
		delete 
		from top_prim_biz_inv_share
		WHERE serial_no = #{serial_no}
	</update>

</mapper>
