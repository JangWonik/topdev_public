<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
<mapper namespace="TopCostTeam">
	
	<select id="getMyInfo" resultType="kr.co.toplac.topteam.TopMbrBscVO" parameterType="String">
	
		SELECT
			a.user_no,
			a.user_name,
			a.home_address,
			a.team_id_main,
			b.team_name,
			a.work_level work_level_cd,
			DATE_FORMAT(FROM_UNIXTIME(a.join_date), '%Y-%m-%d') join_date,
			getCodeValue('top_mbr_bsc','work_level',a.work_level) work_level
		FROM
			top_mbr_bsc a, top_tm_bsc b
		WHERE
			a.user_no = #{user_no} and
			a.team_id_main = b.team_id
			
	</select>

	<select id="getCostTeamList" resultType="kr.co.toplac.topcost.TopCostCompositeVO" parameterType="java.util.HashMap">
		
		 select mbrBsc.user_no
		 	, mbrBsc.user_name
			, item.sum_cost_pay_amt
			, item.sum_cost_deposit_amt
			, item.cost_aprv_state
			, item.cost_no
			, deposit.amt_hq_aprv
			, deposit.amt_finance_aprv
			, deposit.amt_deposit
			, DATE_FORMAT(FROM_UNIXTIME(deposit.date_deposit), '%Y-%m-%d') date_deposit
			, deposit.cost_deposit_no
			, (ifnull(helpClient.sum_traffic_fee,0) + ifnull(helpClient.sum_chart_fee,0)) help1_price
			, (ifnull(helpAccept.sum_traffic_fee,0) + ifnull(helpAccept.sum_chart_fee,0)) help2_price
			, (ifnull(helpAccept.sum_traffic_fee,0) - ifnull(helpClient.sum_traffic_fee,0)) semu1_price
			, (ifnull(helpAccept.sum_chart_fee,0) - ifnull(helpClient.sum_chart_fee,0)) semu2_price
			
		from top_mbr_bsc mbrBsc
		left join
			(select user_no, cost_no, sum(cost_pay_amt) sum_cost_pay_amt, sum(cost_deposit_amt) sum_cost_deposit_amt, cost_aprv_state
			from top_cost_item
			where (cost_occur_date >= UNIX_TIMESTAMP(#{fromdate}) and cost_occur_date &lt; UNIX_TIMESTAMP(#{todate}))
			group by user_no) item
		on mbrBsc.user_no = item.user_no
		left join
			(select user_no, cost_deposit_no, amt_hq_aprv, amt_finance_aprv, amt_deposit, date_deposit
			from top_cost_deposit
			where date_mbr_ins >= UNIX_TIMESTAMP(#{fromdate}) and date_mbr_ins &lt; UNIX_TIMESTAMP(#{todate})
			) deposit
		on mbrBsc.user_no = deposit.user_no
		left join
			(select client_id user_no, sum(traffic_fee) sum_traffic_fee, sum(chart_fee) sum_chart_fee
			from top_rpt_help
			where end_date >= UNIX_TIMESTAMP(#{fromdate}) and end_date &lt; UNIX_TIMESTAMP(#{todate})
			group by client_id) helpClient
		on mbrBsc.user_no = helpClient.user_no
		left join
			(select accept_id user_no, sum(traffic_fee) sum_traffic_fee, sum(chart_fee) sum_chart_fee
			from top_rpt_help
			where end_date >= UNIX_TIMESTAMP(#{fromdate}) and end_date &lt; UNIX_TIMESTAMP(#{todate})
			group by accept_id) helpAccept
		on mbrBsc.user_no = helpAccept.user_no
		where 
		mbrBsc.team_id_main = #{team_id}
;
		
	</select>
	
	<select id="getCostTeamListTotal" resultType="kr.co.toplac.topcost.TopCostCompositeVO" parameterType="java.util.HashMap">
		
		select 
			item.total_cost_pay_amt
			, item.total_cost_deposit_amt
			, deposit.total_amt_hq_aprv
			, deposit.total_amt_finance_aprv
			, deposit.total_amt_deposit
			, deposit.total_cost_sum_mbr_ins
			, (ifnull(helpClient.sum_traffic_fee,0) + ifnull(helpClient.sum_chart_fee,0)) total_help1_price
			, (ifnull(helpAccept.sum_traffic_fee,0) + ifnull(helpAccept.sum_chart_fee,0)) total_help2_price
			, (ifnull(helpAccept.sum_traffic_fee,0) - ifnull(helpClient.sum_traffic_fee,0)) total_semu1_price
			, (ifnull(helpAccept.sum_chart_fee,0) - ifnull(helpClient.sum_chart_fee,0)) total_semu2_price
		from 
			(select sum(cost_pay_amt) total_cost_pay_amt, sum(cost_deposit_amt) total_cost_deposit_amt
			from top_cost_item
			where (cost_occur_date >= UNIX_TIMESTAMP(#{fromdate}) and cost_occur_date &lt; UNIX_TIMESTAMP(#{todate}))
			and team_id = #{team_id}) item
		
		
			,(select sum(amt_hq_aprv) total_amt_hq_aprv, sum(amt_finance_aprv) total_amt_finance_aprv, 
			sum(amt_deposit) total_amt_deposit, sum(cost_sum_mbr_ins) total_cost_sum_mbr_ins
			from top_cost_deposit
			where date_mbr_ins >= UNIX_TIMESTAMP(#{fromdate}) and date_mbr_ins &lt; UNIX_TIMESTAMP(#{todate})
			and team_id = #{team_id}) deposit
		
			,(select sum(traffic_fee) sum_traffic_fee, sum(chart_fee) sum_chart_fee
			from top_rpt_help
			where end_date >= UNIX_TIMESTAMP(#{fromdate}) and end_date &lt; UNIX_TIMESTAMP(#{todate})
			and client_team = #{team_id}) helpClient
		
			,(select sum(traffic_fee) sum_traffic_fee, sum(chart_fee) sum_chart_fee
			from top_rpt_help
			where end_date >= UNIX_TIMESTAMP(#{fromdate}) and end_date &lt; UNIX_TIMESTAMP(#{todate})
			and accept_team = #{team_id}) helpAccept
		
	</select>
	
	<select id="getCostMemberDeposit" resultType="kr.co.toplac.topcost.TopCostCompositeVO" parameterType="java.util.HashMap">
		
		 select mbrBsc.user_no
		 	, mbrBsc.user_name
			, item.sum_cost_pay_amt
			, item.sum_cost_deposit_amt
			, item.cost_aprv_state
			, deposit.amt_hq_aprv
			, deposit.amt_finance_aprv
			, deposit.amt_deposit
			, DATE_FORMAT(FROM_UNIXTIME(deposit.date_deposit), '%Y-%m-%d') date_deposit
			, deposit.cost_deposit_no
			, (ifnull(helpClient.sum_traffic_fee,0) + ifnull(helpClient.sum_chart_fee,0)) help1_price
			, (ifnull(helpAccept.sum_traffic_fee,0) + ifnull(helpAccept.sum_chart_fee,0)) help2_price
			, (ifnull(helpAccept.sum_traffic_fee,0) - ifnull(helpClient.sum_traffic_fee,0)) semu1_price
			, (ifnull(helpAccept.sum_chart_fee,0) - ifnull(helpClient.sum_chart_fee,0)) semu2_price
			
		from top_mbr_bsc mbrBsc
		left join
			(select user_no, sum(cost_pay_amt) sum_cost_pay_amt, sum(cost_deposit_amt) sum_cost_deposit_amt, cost_aprv_state
			from top_cost_item
			where (cost_occur_date >= UNIX_TIMESTAMP(#{fromdate}) and cost_occur_date &lt; UNIX_TIMESTAMP(#{todate}))
			group by user_no) item
		on mbrBsc.user_no = item.user_no
		left join
			(select user_no, cost_deposit_no, amt_hq_aprv, amt_finance_aprv, amt_deposit, date_deposit
			from top_cost_deposit
			where date_mbr_ins >= UNIX_TIMESTAMP(#{fromdate}) and date_mbr_ins &lt; UNIX_TIMESTAMP(#{todate})
			) deposit
		on mbrBsc.user_no = deposit.user_no
		left join
			(select client_id user_no, sum(traffic_fee) sum_traffic_fee, sum(chart_fee) sum_chart_fee
			from top_rpt_help
			where end_date >= UNIX_TIMESTAMP(#{fromdate}) and end_date &lt; UNIX_TIMESTAMP(#{todate})
			group by client_id) helpClient
		on mbrBsc.user_no = helpClient.user_no
		left join
			(select accept_id user_no, sum(traffic_fee) sum_traffic_fee, sum(chart_fee) sum_chart_fee
			from top_rpt_help
			where end_date >= UNIX_TIMESTAMP(#{fromdate}) and end_date &lt; UNIX_TIMESTAMP(#{todate})
			group by accept_id) helpAccept
		on mbrBsc.user_no = helpAccept.user_no
		where 
		mbrBsc.team_id_main = #{team_id} and mbrBsc.user_no = #{user_id}
		ORDER BY mbrBsc.user_name
;
		
	</select>
	
	
	
	
	
</mapper>
